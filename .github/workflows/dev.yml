name: Build and Push Docker Image to Artifactory

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch Name"
        required: true
        default: "develop"

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    name: Build & Push Docker Image to Artifactory
    environment: dev

    steps:
      # Step 1: Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}
          lfs: true

      # Step 2: Log in to Artifactory Docker Registry
      - name: Log in to Artifactory
        run: |
          echo "${{ secrets.ARTIFACTORY_PASSWORD }}" | docker login ${{ secrets.ARTIFACTORY_URL }} -u "${{ secrets.ARTIFACTORY_USERNAME }}" --password-stdin

      # Step 3: Build the Docker image
      - name: Build Docker Image
        run: |
          docker build \
            --file ./devops/docker/app/Dockerfile \
            --tag ${{ secrets.ARTIFACTORY_URL }}/${{ secrets.ARTIFACTORY_REPO_NAME }}/dev-hous-permit-portal:latest \
            --tag ${{ secrets.ARTIFACTORY_URL }}/${{ secrets.ARTIFACTORY_REPO_NAME }}/dev-hous-permit-portal:${{ github.sha }} \
            .
      
      # Step 4: Push the Docker image to Artifactory
      - name: Push Docker Image to Artifactory
        run: |
          docker push ${{ secrets.ARTIFACTORY_URL }}/${{ secrets.ARTIFACTORY_REPO_NAME }}/dev-hous-permit-portal:latest
          docker push ${{ secrets.ARTIFACTORY_URL }}/${{ secrets.ARTIFACTORY_REPO_NAME }}/dev-hous-permit-portal:${{ github.sha }}
